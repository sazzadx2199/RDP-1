name: Windows RDP with Tailscale

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Download Tailscale
      run: |
        Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi -OutFile tailscale.msi
        
    - name: Install Tailscale
      run: |
        Start-Process msiexec.exe -Wait -ArgumentList '/i tailscale.msi /quiet /qn /norestart'
        
    - name: Enable RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
        
    - name: Create User
      run: |
        net user rdpuser RDP@2024Pass /add
        net localgroup administrators rdpuser /add
        
    - name: Connect to Tailscale
      run: |
        & 'C:\Program Files\Tailscale\tailscale.exe' up --authkey=$Env:TAILSCALE_AUTHKEY --hostname=github-rdp
        Start-Sleep -s 5
        $ip = & 'C:\Program Files\Tailscale\tailscale.exe' ip -4
        Write-Host "=========================================="
        Write-Host "RDP Connection Details:"
        Write-Host "Tailscale IP: $ip"
        Write-Host "Username: rdpuser"
        Write-Host "Password: RDP@2024Pass"
        Write-Host "=========================================="
        Write-Host "Connect from any device on your Tailscale network using the IP above"
      env:
        TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        
    - name: Keep Alive
      run: |
        Write-Host "RDP is ready! Connect using the Tailscale IP above."
        Write-Host "This session will stay active for 6 hours."
        Start-Sleep -s 21600
